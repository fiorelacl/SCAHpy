# Uso de SCAHpy

Esta sección presenta la organización interna del paquete y los pasos esenciales para utilizar SCAHpy 
en el análisis de datos océanicos(CROCO) y atmosféricos(WRF) provenientes del modelo acoplado *IGP RESM-COW*.  
El énfasis estará en mostrar el flujo general y las capacidades del paquete, mientras que los detalles específicos
se desarrollarán en los tutoriales posteriores.

## 1. Flujo de trabajo general

El diseño de SCAHpy sigue una estructura modular que permite:

1. **Leer datos, estandarizando coordenadas y dimensiones** del modelo atmosférico WRF y el modelo oceánico CROCO.  
2. **Aplicar diagnósticos** atmosféricos u oceánicos.  
3. **Visualizar** resultados mediante funciones especializadas para mapas, secciones y series temporales.

El flujo conceptual es:

```text
WRF / CROCO ──▶ Lectura ──▶ Diagnósticos ──▶ Visualización
```

Este flujo busca facilitar el análisis reproducible, especialmente en entornos donde se manejan grandes volúmenes de datos, como las simulaciones multianuales del sistema *IGP RESM-COW*.

## 2. Organización del paquete

**SCAHpy** se estructura en módulos que reflejan componentes lógicos del sistema:

| Módulo | Descripción | Ejemplos |
|-------|-------------|----------|
| `components.atmos` | Lectura y diagnósticos para WRF | `wrf_io`, `wrf_coords`, `wrf_diags` |
| `components.ocean` | Lectura y diagnósticos para CROCO | `croco_io`, `croco_coords`, `croco_diags` |
| `core` | Operaciones comunes e independientes del modelo | `coords`, `io`, `time_ops`, `spatial_ops`, `vertical`, `utils` |
| `plots` | Funciones de visualización | `maps`, `sections`, `timeseries` |

El propósito es mantener ordenadas las funciones según el dominio físico (atmósfera, océano) o según el tipo de operación (tiempo, espacio, vertical).

## 3. Importación del paquete

SCAHpy puede importarse de distintas maneras dependiendo del nivel de control y claridad que desees en tu flujo de trabajo. 
A continuación se muestran los métodos más comunes.

### Importación básica

```python
import scahpy

scahpy.components.atmos.wrf_io.read_wrf()
scahpy.read_wrf()
```
también se puede abreviar el nombre del paquete

```python
import scahpy as sc

sc.read_wrf()
```
### Importación explícita (recomendada)

Para una mayor claridad, especialmente en proyectos científicos y scripts reproducibles, se recomienda utilizar importaciones explícitas:

```python
from scahpy import plots

plots.map_1var_winds()
```
O bien importar módulos específicos:

```python
from scahpy.components.atmos import wrf_io, wrf_diags

wrf_io.read_wrf()
```

### Importación de dependencias comunes

En muchos ejemplos y tutoriales trabajarás con bibliotecas utilizadas como:

```python
import glob
import xarray as xr
import matplotlib.pyplot as plt
```

## 4. Lectura de datos

La lectura es el primer paso fundamental. SCAHpy ofrece funciones especializadas para WRF y CROCO que:

* aceptan rutas como listas de archivos,
* estandarizan coordenadas (`lat`, `lon`, `time`),
* corrigen tiempo local/UTC,
* aplican *destaggering* cuando corresponde,
* calculan variables auxiliares internas.

### 4.1 Lectura de archivos WRF

Asumimos que se importó la librería como `{python} import scahpy as sc`

```python
WRF_files  = sorted(glob.glob("/data/users/fcastillon/wrf/wrfout_d01_2017*"))
vars_wrf = sc.drop_vars(WRF_files[0], sel_vars = ['SST','LANDMASK','U10','V10','T2'], model='WRF')
ds_wrf = sc.read_wrf(WRF_files, drop_vars = vars_wrf)
```
![ds_wrf](figs/fig_01.png){#fig-01 fig-align="center" width="75%"}


Salida:

* Dataset con coordenadas homogéneas
* Tiempo concatenado
* Opcional: se puede usar el parámetro `{python} destag = True` si fuera el caso, así como
`{python} save_path = 'ruta_salida/archivo.nc'` para guardar el netcdf generado.


### 4.2 Lectura de archivos CROCO

Asumimos que se importó la librería como `{python} import scahpy as sc`


```python
CROCO_files = sorted(glob.glob("/data/users/fcastillon/croco/croco_avg_Y2017*.nc"))
vars_croco = sc.drop_vars(CROCO_files[0], sel_vars = ['temp','mask_rho','ubar','vbar'], model='CROCO')
ds_croco = sc.read_croco(CROCO_files, drop_vars = vars_croco,)
```
![ds_croco](figs/fig_02.png){#fig-02 fig-align="center" width="75%"}

Salida:

* Dataset con coordenadas homogéneas
* Tiempo concatenado
* Coordenadas renombradas a `time`, `lat`, `lon`, `levels`

## 5. Diagnósticos océano - atmosféricos

### 5.1 Diagnósticos WRF

El resultado de un diagnóstico es un `xr.DataArray`
```python
da_rh = sc.rh(ds_wrf.T, ds_wrf.P, ds_wrf.PB, ds_wrf.QVAPOR)
```
No obstante si se asigna de la siguiente forma se puede agregar al dataset `ds_wrf` y pasaría a ser parte de un `xr.Dataset`

```python
ds_wrf['RH'] = sc.rh(ds_wrf.T, ds_wrf.P, ds_wrf.PB, ds_wrf.QVAPOR)
```

### 5.2 Diagnósticos CROCO

Uno de los diagnósticos incluídos es vorticidad en superficie

```python
ds_croco['vort_sfc'] = sc.vorticity_sfc(
    u = ds_croco.u.isel(level=-1),
    v = ds_croco.v.isel(level=-1),
    pm = ds_croco.pm,
    pn = ds_croco.pn,
    mask = ds_croco.mask_rho,
    f = ds_croco.f,
    normalize_by_f = False
)
```

## 6. Visualización

El módulo `components.plots` contiene funciones listas para generar figuras de alta calidad científica. Una de las más clásicas es la de mapas.

```python
maps.map_1var_winds(
    ds=ds_wrf.T2,
    U=ds_wrf.U10,
    V=ds_wrf.V10,
    levels=np.arange(16,31,1),
    cmap="thermal",
    time='2017-01-02T12',
    title="T2 + 10m Winds"
)
```
![ds_maps](figs/fig_03.png){#fig-03 fig-align="center" width="75%"}
