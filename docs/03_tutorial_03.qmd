# Tutorial 3: Variables en niveles de presión y secciones verticales

En este tutorial aprenderás a:

1. Leer múltiples archivos WRF.  
2. Calcular humedad específica y presión total.  
3. Agregar datos a escala diaria.  
4. Interpolar variables a niveles estándar de presión (hPa).  
5. Crear una sección vertical (X–Z) de humedad y viento.

Este tipo de análisis es fundamental cuando se trabaja con perfiles atmosféricos y cortes verticales, especialmente para estudios sinópticos y validaciones climatológicas.

---

# 1. Importación de librerías

```python
import scahpy as sph

from scahpy.components.atmos import wrf_io, wrf_diags
from scahpy.components.core import (
    time_ops,
    vertical,
    utils
)
from scahpy.components.plots import sections

import xarray as xr
import matplotlib.pyplot as plt
import glob
````

---

# 2. Lectura de múltiples archivos WRF

Al igual que en el tutorial anterior, listamos archivos usando `glob`.

```python
list_files = sorted(
    glob.glob("/data/datos/COW/OUT_DIAG_WRF/wrfouts/wrfout_d01_2023-03-*.nc")
)
list_files[:3]
```

## Lectura con SCAHpy

```python
ds = wrf_io.read_wrf(
    paths=list_files,
    drop_vars=["TKE"],           # opcional
    time_offset_hours=-5         # convertir UTC → hora local Perú
)
ds
```

Salida típica:

* `time`: concatenado automáticamente
* `lat`, `lon`
* `bottom_top`: niveles sigma
* Variables como `T`, `P`, `PB`, `QVAPOR`, `U`, `W`

---

# 3. Cálculo de humedad específica (QE) y presión total (Ptot)

En tu tutorial antiguo esto se hacía con `met_vars`.
Ahora existe un flujo más claro usando **wrf_diags** y operaciones básicas.

## 3.1 Humedad específica (QE)

```python
qe = wrf_diags.qe(
    qv=ds["QVAPOR"],
    p=ds["P"],
    pb=ds["PB"]
)
qe.name = "QE"
```

## 3.2 Presión total (en hPa)

```python
ptot = wrf_diags.total_pressure(
    p=ds["P"],
    pb=ds["PB"]
) / 100.0
ptot.name = "pressure"
```

Podemos combinarlo en un solo dataset:

```python
ds_lvl = xr.Dataset({
    "QE": qe,
    "pressure": ptot,
    "U": ds["U"],
    "W": ds["W"],
})
```

---

# 4. Agregación temporal (diaria)

Antes usabas `temp_scales.dmy_var`.
Ahora se reemplaza por `resample` directamente con xarray.

### 4.1 Promedio diario

```python
ds_daily = ds_lvl.resample(time="1D").mean()
ds_daily
```

---

# 5. Interpolación a niveles de presión estándar

SCAHpy permite interpolar verticalmente usando:

```python
vertical.vertical_interp()
```

### Niveles estándar por defecto (siempre en hPa):

```
1000, 975, 950, 925, 900,
850, 800, 700, 600, 500,
400, 300, 200
```

### Interpolación:

```python
new_levels = [1000, 925, 850, 700, 500, 300]

qe_p = vertical.vertical_interp(
    da=ds_daily["QE"],
    coord_in=ds_daily["pressure"],
    new_levels=new_levels,
    dim="bottom_top"
)
qe_p.name = "QE_p"

u_p = vertical.vertical_interp(
    da=ds_daily["U"],
    coord_in=ds_daily["pressure"],
    new_levels=new_levels,
    dim="bottom_top"
)

w_p = vertical.vertical_interp(
    da=ds_daily["W"],
    coord_in=ds_daily["pressure"],
    new_levels=new_levels,
    dim="bottom_top"
)
```

Creamos un dataset interpolado:

```python
ds_p = xr.Dataset({
    "QE": qe_p,
    "U": u_p,
    "W": w_p,
})
```

---

# 6. Sección vertical X–Z (lat fija)

Para una sección vertical, por ejemplo a **latitud -5°**:

```python
section = ds_p.sel(lat=-5, method="nearest")
```

Y limitamos en longitud:

```python
section = section.sel(lon=slice(-90, -80))
```

Opcionalmente escogemos un rango de días:

```python
section = section.sel(time=slice("2023-03-10", "2023-03-13"))
```

La humedad a veces se expresa en g/kg:

```python
section["QE"] = section["QE"] * 1000.0
```

---

# 7. Gráfico de sección vertical (X–Z)

Para graficar, usamos:

```
sections.section_xz_1var()
```

Ejemplo:

```python
levels_qe = [0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 5, 7, 10]

sections.section_xz_1var(
    ds=section,
    var_name="QE",
    time_index=0,
    cmap="viridis",
    quiver_var_u="U",
    quiver_var_w="W",
    quiver_scale=100,
    title="Sección vertical X–Z de humedad específica",
)
```