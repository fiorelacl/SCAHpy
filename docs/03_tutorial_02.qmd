# Tutorial 2: Lectura y análisis de múltiples archivos WRF

En este tutorial aprenderás a:

1. Leer **varios archivos WRF** (multi-tiempo) usando SCAHpy.  
2. Calcular precipitación total, viento 10 m y SST.  
3. Agregar datos a escala diaria.  
4. Realizar una visualización básica.

Este flujo es esencial para procesar días, meses o años de simulación del sistema **IGP RESM-COW**.

---

# 1. Importación del paquete

Como en el tutorial anterior, importamos los módulos necesarios:

```python
import scahpy as sph

from scahpy.components.atmos import wrf_io, wrf_diags
from scahpy.components.core import (
    time_ops,
    utils
)
from scahpy.components.plots import maps

import xarray as xr
import matplotlib.pyplot as plt
import glob
````

---

# 2. Lectura de múltiples archivos WRF

## 2.1 Listar archivos

Como mencionaste, por ahora prefieres usar `glob`:

```python
list_files = sorted(
    glob.glob("/data/datos/COW/OUT_DIAG_WRF/wrfouts/wrfout_d01_2023-03-*.nc")
)
list_files[:3]
```

Ejemplo de salida:

```
['wrfout_d01_2023-03-01_00:00:00',
 'wrfout_d01_2023-03-01_03:00:00',
 'wrfout_d01_2023-03-01_06:00:00',
 ...]
```

## 2.2 Leer todos los archivos concatenados

Antes usabas:

```python
ds = in_out.read_wrf_multi(...)
```

Ahora se reemplaza por **una sola función moderna**:

```python
ds = wrf_io.read_wrf(
    paths=list_files,
    drop_vars=["TKE"],
    time_offset_hours=-5      # convertir UTC → hora local Perú
)
ds
```

SCAHpy ahora:

* concatena el tiempo automáticamente,
* estandariza coordenadas (`lat`, `lon`),
* corrige tipos y atributos,
* maneja destaggering cuando corresponde.

---

# 3. Cálculo de diagnósticos (precipitación, viento y SST)

## 3.1 Precipitación acumulada

```python
pp = ds["RAINC"] + ds["RAINNC"]
pp.name = "PP"
```

## 3.2 Velocidad del viento a 10 m

```python
wspd10 = wrf_diags.wind_speed(ds["U10"], ds["V10"])
wspd10.name = "wspd10"
```

## 3.3 SST en grados Celsius (si existe)

```python
if "SSTSK" in ds:
    sst = utils.to_celsius(ds["SSTSK"])
    sst.name = "SST_C"
```

---

# 4. Agregación temporal (diaria)

En tu versión antigua tenías:

```python
dd = temp_scales.dmy_var(...)
```

Ahora se usa un flujo más simple y universal con `time_ops`:

## 4.1 Agrupar por día

```python
# Precipitación diaria (suma)
pp_daily = pp.resample(time="1D").sum()

# Viento diario (promedio)
wspd10_daily = wspd10.resample(time="1D").mean()

# SST diaria (mediana)
if "SSTSK" in ds:
    sst_daily = sst.resample(time="1D").median()
```

Agrupar así permite un control claro y reproducible.

Puedes combinarlo en un solo Dataset:

```python
ds_daily = xr.Dataset(
    {
        "PP": pp_daily,
        "wspd10": wspd10_daily,
        "SST_C": sst_daily if "SSTSK" in ds else None,
    }
)
ds_daily
```

---

# 5. Visualización básica

Para trazar un día específico:

```python
day0 = ds_daily.sel(time="2023-03-01")
```

Mapa simple:

```python
day0["PP"].plot(
    x="lon", y="lat",
    cmap="Blues",
    cbar_kwargs={"label": "Precipitación diaria (mm)"}
)
plt.title("Precipitación diaria – 1 marzo 2023 (WRF)")
plt.show()
```

---

# 6. Visualización usando funciones de SCAHpy

Si deseas usar funciones de `components.plots`, por ejemplo para 1 variable:

```python
maps.map_1var(
    ds=ds_daily,
    var_name="PP",
    time_index=0,
    cmap="Blues",
    title="Precipitación diaria acumulada"
)
```
# Tutorial 1: Lectura de un archivo CROCO
# 5. Lectura rápida de un archivo CROCO

Además de WRF, SCAHpy permite trabajar con salidas del modelo oceánico **CROCO**, utilizado en el componente marino del IGP RESM-COW.

## 5.1 Definir la ruta del archivo CROCO

Como ejemplo:

```python
croco_file = "/data/datos/COW/OUT_DIAG_CROCO/croco_avg_Y2000M01.nc"
```

Nuevamente usaremos una lista, aunque solo haya un archivo:

```python
ds_croco = croco_io.read_croco(
    paths=[croco_file],   # lista con un único archivo
    destag=True,          # pasar de grilla C a grilla centrada
    keep_vertical=True    # conservar niveles sigma
)
ds_croco
```

El resultado suele incluir:

* `time`: tiempos diarios o subdiarios,
* `eta_rho`, `xi_rho` o equivalentes convertidos a `lat`, `lon`,
* `s_rho` o niveles sigma,
* Variables oceánicas: `temp`, `salt`, `u`, `v`, etc.

---

# 6. Mapa simple de SST con CROCO

Suponiendo que la variable de temperatura se llama `temp` y que el último nivel vertical corresponde aproximadamente a la superficie:

```python
sst = ds_croco["temp"].isel(s_rho=-1)  # último nivel = superficie
sst.name = "SST"
```

Tomamos, por ejemplo, el primer tiempo:

```python
sst.isel(time=0).plot(
    x="lon", y="lat",
    cmap="viridis",
    cbar_kwargs={"label": "SST (°C)"}
)
plt.title("Temperatura superficial del mar – CROCO (archivo único)")
plt.show()
```

También puedes usar la función de SCAHpy:

```python
maps.map_1var(
    ds=ds_croco,
    var_name="temp",
    time_index=0,
    level_index=-1,    # superficie
    title="SST – CROCO (archivo único)"
)
```